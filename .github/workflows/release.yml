# .github/workflows/release.yml
# GitHub Actions workflow for releasing the Go project
name: Release

on:
  # Trigger workflow manually with a version input
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version'
        required: true

permissions:
  # Allow workflow to write to repository contents (for pushing tags)
  contents: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout the repository with full history
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 2: Create and push a Git tag for the release
      - name: Create and push Git tag
        run: |
          TAG_NAME="${{ github.event.inputs.version }}"

          # Check if the tag already exists
          if git rev-parse "refs/tags/${TAG_NAME}" >/dev/null 2>&1; then
            echo "Tag ${TAG_NAME} already exists. Exiting..."
            exit 1
          fi

          # Create the tag
          git tag "${TAG_NAME}"
          echo "Created tag ${TAG_NAME}"

          # Push the tag to the remote
          git push origin "refs/tags/${TAG_NAME}"

      # Step 3: Set up Go environment
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: stable

      # Step 4: Set up QEMU for cross-platform Docker builds
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # Step 5: Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.REGESTRY_USERNAME }}
          password: ${{ secrets.REGESTRY_PASSWORD }}

      # Step 6: Run GoReleaser to build and publish release artifacts
      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # GitHub token for authentication

      # Step 7: Generate build timestamp
      - name: Generate build timestamp
        id: build_date
        run: echo "timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      # Step 8: Build and push multi-arch Docker image using Buildx
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./release.dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            reportportal/mcp-server:${{ github.event.inputs.version }}
            reportportal/mcp-server:latest
          build-args: |
            VERSION=${{ github.event.inputs.version }}
            COMMIT=${{ github.sha }}
            BUILD_DATE=${{ steps.build_date.outputs.timestamp }}
          labels: |
            io.artifacthub.package.readme-url=https://raw.githubusercontent.com/reportportal/reportportal-mcp-server/main/README.md
            io.artifacthub.package.logo-url=https://avatars.githubusercontent.com/u/17636279
            io.artifacthub.package.maintainers=[{"name":"Andrei Varabyeu","email":"andrei_varabyeu@epam.com"},{"name":"Aleksandr Paramonov","email":"aleksandr_paramonov@epam.com"}]
            org.opencontainers.image.description=ReportPortal MCP Server
            org.opencontainers.image.name=reportportal-mcp-server
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.version=${{ github.event.inputs.version }}
            org.opencontainers.image.source=https://github.com/reportportal/reportportal-mcp-server
            org.opencontainers.image.created=${{ steps.build_date.outputs.timestamp }}